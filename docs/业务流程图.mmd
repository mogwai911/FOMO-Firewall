flowchart TD
  A[用户配置 RSS 源] --> B[系统定时拉取 Feed]
  B --> C[解析条目/去重/入线索池 Signals]

  C --> D["Agent Async&#47;Batch 生成日报 Digest<br/>控量筛选&#47;去重合并&#47;排序"]
  D --> E[日报处置面板<br/>每条=一条线索]

  %% Triage card must be: conclusion-reasons-next
  E --> F["[Agent Async/Prefetch] 生成处置卡 TriageCard<br/>L1: FYI / Do / Drop<br/>+ 一句话结论<br/>+ Reasons≤3 + Snippets≤2<br/>+ 建议下一步"]
  F --> G{用户采纳标签?}
  G -->|改判| H[用户选择 FYI/Do/Drop]
  G -->|采纳| I[使用 Agent 标签]

  %% Log
  H --> J[记录处置结果/反馈信号]
  I --> J
  J --> DB[(DB: EventLog<br/>user_id, signal_id, event_type, payload, ts)]

  %% Branch by label (no Watch)
  J --> K{L1 标签}
  K -->|Drop| K1[忽略清理]
  K -->|FYI| K2[可选：收藏到「稍后看」]
  K -->|Do| L[进入学习对话 Session]

  %% Session: default save full logs
  L --> S0[创建/恢复 Session<br/>默认保存全量对话日志]
  S0 --> SDB[("DB: SessionStore<br/>session_id, signal_id, messages[], status")]
  
  %% Learning chat
  S0 --> M["[Agent Sync] 生成问题卡(3-5个)<br/>或用户直接提问"]
  M --> N[与 Agent 对话学习]
  N --> O{用户退出对话?}
  O -->|继续| N
  O -->|退出| P[结束/暂存 Session<br/>返回日报继续处置]

  %% Optional async generation (user-triggered)
  O --> Q1[用户点击：生成洞察卡] 
  O --> Q2[用户点击：生成证据包摘要]

  Q1 --> J1[("JobQueue: enqueue insight_card_job")]
  Q2 --> J2[("JobQueue: enqueue evidence_job")]

  J1 --> R1["[Agent Async] 生成洞察卡(1张高密度画布)"]
  R1 --> MC[(Insight Cards 库<br/>高频：划卡复习/搜索)]

  J2 --> R2["[Agent Async] 生成证据包摘要<br/>对话全量日志已在 SessionStore"]
  R2 --> EP[(Evidence Pack 库<br/>低频：回看思维链/依据)]
